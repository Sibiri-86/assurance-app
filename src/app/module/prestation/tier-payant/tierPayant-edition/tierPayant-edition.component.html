<script src="tierPayant-edition.component.ts"></script>
<div class="p-grid">
	<div class="p-col-12">
		<p-toast></p-toast>
		<div class="card">
			<p-toolbar styleClass="p-mb-4">
				<ng-template pTemplate="left">
					<button pButton pRipple label="Ajouter" icon="pi pi-plus" class="p-button-success p-mr-2 p-mb-2" (click)="addTierPayant()"></button>
					<button pButton pRipple label="Supprimer" [disabled]="TierPayantSelected?.length<1" icon="pi pi-trash" (click)="supprimerPrefinancement()" class="p-button-danger p-mb-2"></button>
				</ng-template>
                <!--
				<ng-template pTemplate="right">
					<p-fileUpload mode="basic" accept="image/*" [maxFileSize]="1000000" label="Import" chooseLabel="Import" class="p-mr-2 p-mb-2 p-d-inline-block" ></p-fileUpload>
					<button pButton pRipple label="Export" icon="pi pi-upload" class="p-button-help p-mb-2" (click)="dt.exportCSV()"></button>
				</ng-template>
                -->
			</p-toolbar>


            <p-table #dt [value]="sinistreTierPayantDTOList" [autoLayout]="true" [columns]="cols" [rows]="10" [paginator]="true" [globalFilterFields]="['garant.nom','intermediaire.nom','numero','taux.taux']"
                     [rowHover]="true" dataKey="id"
                     styleClass="p-datatable-customers"
                     currentPageReportTemplate="affichage {first} à {last} de {totalRecords} enregistrement" [showCurrentPageReport]="true" [(selection)]="TierPayantSelected">
                <ng-template pTemplate="caption">
                    <div class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between table-header">
                        <h5 class="p-m-0"></h5>
                        <span class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Search..." />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th pSortableColumn="numero" style="min-width:200px">Numero sinistre<p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="min-width:200px">Date declaration<p-sortIcon field="nom"></p-sortIcon></th>
                        <!--<th pSortableColumn="territorialite" style="min-width:200px">Date soins<p-sortIcon field="territorialite.libelle"></p-sortIcon></th>-->
                        <th pSortableColumn="duree" style="min-width:100px">Numero Adherent<p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="duree" style="min-width:100px">Numero de facture<p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="dateEffet" style="min-width:200px">Nom <p-sortIcon field="dateEffet"></p-sortIcon></th>
                        <th pSortableColumn="dateEcheance" style="min-width:200px">Prenom<p-sortIcon field="dateEcheance"></p-sortIcon></th>
                        <th style="min-width:150px"></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-tierPayant>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="tierPayant"></p-tableCheckbox>
                        </td>
                        <td><span class="p-column-title" style="min-width:200px">{{tierPayant.numeroSinistre}}</span>
                        </td>
                        <td><span class="p-column-title" style="min-width:200px">{{tierPayant.dateDeclaration | formatTableValue : 'date'}}</span>
                        </td>

                        <!--<td><span class="p-column-title" style="min-width:200px">{{tierPayant.dateSoins | formatTableValue : 'date'}}</span>
                        </td>-->
                        <td>
                            <span class="p-column-title" style="min-width:100px">{{tierPayant.adherent.numero}}</span>
                        </td>
                        <td>
                            <span class="p-column-title" style="min-width:100px">{{tierPayant.numeroFacture}}</span>
                        </td>
                        <td>
                            <span class="p-column-title" style="min-width:200px">{{tierPayant.adherent.nom}}</span>
                        </td>
                        <td>
                            <span class="p-column-title" style="min-width:200px">{{tierPayant.adherent.prenom}}</span>
                        </td>

                        <td style="min-width:150px">
                            <button pButton pRipple icon="pi pi-pencil" pTooltip="editer" class="p-button-rounded p-button-warning p-mr-2" (click)="editerPrestation(tierPayant)"></button>
                            <button pButton  pRipple icon="pi pi-search" pTooltip="voir prestation" class="p-button-rounded p-button-help p-mr-2" (click)="voirPrestation(tierPayant)"></button>
                            <button pButton icon="pi pi-check" pTooltip="Valider" class="p-button-rounded p-button-success p-mr-2" (click)="validerPrestation(tierPayant)"></button>
                            <button pButton pRipple icon="pi pi-print" pTooltip="Imprimer" class="p-button-rounded p-button-info" (click)="imprimer(tierPayant)"></button>
                    </td>

                        <!--
                        <td>
                            <button pButton pRipple icon="pi pi-pencil" pTooltip="editer" class="p-button-rounded p-button-success p-mr-2" (click)="editPolice(police)"></button>
                            <button pButton pRipple icon="pi pi-trash" pTooltip="Supprimer" class="p-button-rounded p-button-warning p-mr-2" (click)="deletePolice(police)"></button>
                            <button pButton  pRipple icon="pi pi-eye" pTooltip="voir groupe" class="p-button-rounded p-button-info p-mr-2" (click)="voirGroupe(police)"></button>
                            <button pButton  pRipple icon="pi pi-search" pTooltip="voir details" class="p-button-rounded p-button-help p-mr-2" (click)="onRowSelectPolice(police)"></button>
                            <button pButton  [disabled]="!police.listGroupe ||!police.listGroupe.length" icon="pi pi-check" pTooltip="Valider" class="p-button-rounded p-button-info p-mr-2" (click)="validerPolice(police)"></button>
                            <button pButton  [disabled]="!police.listGroupe ||!police.listGroupe.length" pRipple icon="pi pi-print" pTooltip="Imprimer" class="p-button-rounded p-button-info" (click)="imprimer(police)"></button>
                        </td>
                        -->

                    </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        {{sinistreTierPayantDTOList ? sinistreTierPayantDTOList.length : 0 }} sinistre(s).
                    </div>
                </ng-template>
            </p-table>
        </div>


        <p-dialog [maximizable]="true" [(visible)]="displayPrestation" header="Prestation(s)" [modal]="true" styleClass="p-fluid" [style]="{width: '1100px'}">
            <ng-template pTemplate="content">
                <div class="card">
                    <p-table #dt [value]="prestationListPrefinancementFilter" [columns]="cols" [rows]="10" [paginator]="true"
                     [rowHover]="true" dataKey="id"
                     styleClass="p-datatable-customers"
                     currentPageReportTemplate="affichage {first} à {last} de {totalRecords} enregistrement" [showCurrentPageReport]="true">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="nombreActe" style="width: 150px">nombre acte<p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="width: 150px">Cout unitaire<p-sortIcon field="nom"></p-sortIcon></th>
                        <th pSortableColumn="taux" style="width: 150px">Débours<p-sortIcon field="taux.taux"></p-sortIcon></th>
                        <th pSortableColumn="territorialite" style="width: 150px">Base de remboursement<p-sortIcon field="territorialite.libelle"></p-sortIcon></th>
                        <th pSortableColumn="duree" style="width: 150px">montant remboursé <p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="dateSoins" style="width: 150px">Date Soins <p-sortIcon field="duree"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-prestation>
                    <tr>

                        <td><span class="p-column-title">{{prestation.nombreActe}}</span>
                        <td><span class="p-column-title">{{prestation.coutUnitaire}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.debours}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.baseRemboursement}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.montantRembourse}}</span></td>
                        <td><span class="p-column-title">{{prestation.dateSoins | formatTableValue: 'date'}}</span></td>
                        <td style="min-width:150px">
                            <button pButton pRipple icon="pi pi-trash" pTooltip="supprimer" class="p-button-rounded p-button-warning p-mr-2" (click)="supprimerPrestation(prestation)"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        {{prestationListPrefinancement ? prestationListPrefinancement.length : 0 }} prestation(s).
                    </div>
                </ng-template>
            </p-table>
                </div>
            </ng-template>
        </p-dialog>


        <p-dialog [maximizable]="true" [style]="{width: '1500px'}" [(visible)]="displayFormPrefinancement" header="Tiers Payant" [modal]="true" styleClass="p-fluid" (onHide)="closeDialog()">
            <ng-template pTemplate="content">
                <div class="card">


                    <form (ngSubmit)="onCreate()"  [formGroup]="prestationForm">

                        <p-fieldset legend="Sinistre" toggleable="true">

                            <div class="p-fluid p-formgrid p-grid">

                                <div class="p-field p-col">
                                    <label for="dateEffet">Date de saisie <span style="color: red !important;">*</span></label>
                                    <p-calendar id="dateSaisie" [showIcon]="true" dateFormat="dd/mm/yy" inputId="calendar" formControlName="dateSaisie" appendTo="body"></p-calendar>
                                </div>

                                <div class="p-field p-col">
                                    <label for="dateEffet">Date de declaration <span style="color: red !important;">*</span></label>
                                    <p-calendar id="dateDeclaration"   [showIcon]="true" dateFormat="dd/mm/yy" inputId="calendar"
                                                formControlName="dateDeclaration" appendTo="body"></p-calendar>
                                </div>
                                <div class="p-field p-col">
                                    <label for="numeroFacture" >Numéro Facture<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                    <input id="numeroFacture" type="text" formControlName="numeroFacture" placeholder="numero de facture" pInputText>

                                </div>
                                <div class="p-field p-col">
                                    <label for="matriculeAdherent">Matricule adhérent<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                    <input id="matriculeAdherent" type="text" formControlName="matriculeAdherent" (blur)="rechercherAdherent($event)" pInputText>
                                </div>

                            </div>

                            <div class="p-fluid p-formgrid p-grid">

                                <div class="p-field p-col">
                                    <label for="nomAdherent">Nom <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <input id="nomAdherent" class="champ" type="text" formControlName="nomAdherent" pInputText>
                                </div>

                                <div class="p-field p-col">
                                    <label for="nomAdherent">Prenom<span class="required">*</span></label>
                                    <input id="prenomAdherent" class="champ" type="text" formControlName="prenomAdherent" pInputText>
                                </div>

                                <div class="p-field p-col">
                                    <label for="groupeAdherent">Numéro du groupe<span class="required">*</span></label>
                                    <input id="groupeAdherent" class="champ" type="text" formControlName="numeroGroupe" pInputText>
                                </div>
                                <div class="p-field p-col">
                                    <label for="nomGroupeAdherent">Nom du groupe<span class="required">*</span></label>
                                    <input id="nomGroupeAdherent" class="champ" type="text" formControlName="nomGroupeAdherent" pInputText>
                                </div>

                            </div>

                            <div class="p-fluid p-formgrid p-grid">

                                <div class="p-field p-col-3">
                                    <label for="policeAdherent">Numéro de la police<span class="required">*</span></label>
                                    <input id="policeAdherent" class="champ" type="text" formControlName="numeroPolice" pInputText>
                                </div>
                                <div class="p-field p-col-3">
                                    <label for="nomPoliceAdherent">Souscripteur<span class="required">*</span></label>
                                    <input id="nomPoliceAdherent" class="champ" type="text" formControlName="nomPoliceAdherent" pInputText>
                                </div>

                            </div>

                            <div class="p-field p-col-2"></div>
                            <div class="p-field p-col-2">
                                <button pButton [disabled]="!adherentSelected"
                                        pRipple icon="pi pi-plus" pTooltip="Ajouter prestation" label="Ajouter prestation"
                                        class="p-button-success" type="button" (click)="addItemPrestation()"></button>
                            </div>

                        </p-fieldset>

                        <hr/>




                        <div formArrayName="prestation" *ngFor="let item of prestationForm.get('prestation')['controls']; let i = index;">
                            <div [formGroup]="item">

                                <p-fieldset [legend]="'Prestation '+(i+1)" toggleable="true">

                                    <div class="p-fluid p-formgrid p-grid">


                                        <div class="p-field p-col">
                                            <label for="dateSoins">Date de soins <span style="color: red !important;">*</span></label>
                                            <p-calendar id="dateSoins"   [showIcon]="true" dateFormat="dd/mm/yy" placeholder="date de Soins" inputId="calendar" formControlName="dateSoins" appendTo="body"></p-calendar>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="familleActe">Famille acte<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-dropdown dataKey="id" inputId="garantie" [filter]="true" showClear="true" placeholder="Select famille-acte"
                                                        [options]="garanties" formControlName="familleActe" [autoDisplayFirst]="false"
                                                        optionLabel="libelle" (onChange)="changeGarantie($event)"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="acte">Acte<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-dropdown dataKey="id" inputId="acte" [autoDisplayFirst]="false" [filter]="true" showClear="true" placeholder="Select acte"
                                                        [options]="acteListFilter" formControlName="acte" optionLabel="libelle" (onChange)="selectActe($event)"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="sousActe" id="sousActe">SousActe <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-dropdown inputId="sousActe" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="sousActeListFilter"
                                                        formControlName="sousActe" placeholder="Select sous-acte"
                                                        optionLabel="libelle"></p-dropdown>
                                        </div>


                                    </div>

                                    <div class="p-fluid p-formgrid p-grid">

                                        <div class="p-field p-col">
                                            <label for="pathologie" id="pathologie">Pathologie</label>
                                            <p-dropdown inputId="pathologie" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="pathologieList"
                                                        formControlName="pathologie" placeholder="Select pathologie "
                                                        optionLabel="code"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="prestataire" id="prestataire">Centre Prescripteur</label>
                                            <p-dropdown inputId="prestataire" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="prestataireList"
                                                        formControlName="prestataire" placeholder="Select centre prescripteur"
                                                        optionLabel="libelle"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="prestataire" id="centreExecutant">Centre Exécutant</label>
                                            <p-dropdown inputId="centreExecutant" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="prestataireList"
                                                        formControlName="centreExecutant" placeholder="Select centre exécutant"
                                                        optionLabel="libelle"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="produitPharmaceutique" id="produitPharmaceutique">Produit pharmaceutique</label>
                                            <p-dropdown inputId="produitPharmaceutique" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="produitPharmaceutiqueList"
                                                        formControlName="produitPharmaceutique" placeholder="Select produit pharmaceutique "
                                                        optionLabel="libelle"></p-dropdown>
                                        </div>

                                    </div>

                                    <div class="p-fluid p-formgrid p-grid">
                                        <div class="p-field p-col">
                                            <label for="medecin" id="medecin">Medecin</label>
                                            <p-dropdown inputId="medecin" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="medecinList"
                                                        formControlName="medecin" placeholder="Select medecin"
                                                        optionLabel="libelle"></p-dropdown>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="nombreActe" id="nombreActe">Nombre Acte <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-inputNumber formControlName="nombreActe" mode="decimal" locale="fr-FR" placeholder="Nombre Acte" (onBlur)="calculDebours(i)"></p-inputNumber>
                                        </div>
                                        <div class="p-field p-col">
                                            <label for="coutUnitaire" id="coutUnitaire">Cout unitaire <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-inputNumber formControlName="coutUnitaire" mode="decimal" locale="fr-FR" placeholder="cout unitaire" (onBlur)="calculDebours(i)"></p-inputNumber>
                                        </div>
                                        <div class="p-field p-col">
                                            <label for="debours" id="debours">Debours <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-inputNumber formControlName="debours" mode="decimal" locale="fr-FR"></p-inputNumber>
                                        </div>

                                    </div>

                                    <div class="p-fluid p-formgrid p-grid">
                                        <div class="p-field p-col">
                                            <label for="baseRemboursement" id="baseRemboursement">Base remboursement<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-inputNumber formControlName="baseRemboursement" mode="decimal" locale="fr-FR" placeholder="base de remboursement"></p-inputNumber>
                                        </div>

                                        <div class="p-field p-col">
                                            <label for="taux" id="taux">Taux <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-dropdown inputId="taux" dataKey="id" [filter]="true"
                                                        showClear="true" [options]="tauxList"
                                                        formControlName="taux" placeholder="Select taux"
                                                        optionLabel="taux"></p-dropdown>
                                        </div>
                                        <div class="p-field p-col-3">
                                            <label for="montantRembourse" id="montantRembourse">Montant remboursé<sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-inputNumber formControlName="montantRembourse" mode="decimal" locale="fr-FR" ></p-inputNumber>
                                        </div>
                                        <div class="p-field p-col-3">
                                            <label for="sort" id="sort">Sort <sup style="color: red !important; size: 1.4em;">*</sup></label>
                                            <p-dropdown inputId="sort"  [filter]="true"
                                                        showClear="true" [options]="typeSort"
                                                        formControlName="sort"></p-dropdown>
                                        </div>

                                    </div>
                                    <div class="p-fluid p-formgrid p-grid">
                                    <div class="p-field p-col">
                                        <label for="observation" id="observation">Observation</label>
                                        <textarea pInputTextarea formControlName="observation" autoResize="autoResize"></textarea>
                                    </div>
                                    </div>

                                    <div class="p-fluid p-formgrid p-grid">
                                        <div class="p-field p-col-2">
                                            <button pButton pRipple icon="pi pi-plus" pTooltip="Supprimer prestation" label="Supprimer prestation"
                                                    class="p-button-success" type="button" (click)="deleteItemPrestation(i)"></button>
                                        </div>
                                    </div>

                                </p-fieldset>

                            </div>
                        </div>

                        <br/>

                        <div class="p-grid p-justify-between">
                            <div>
                                <button pButton pRipple label="Quitter" icon="pi pi-times"  class="p-button-danger p-mr-2 p-mb-2" ></button>
                            </div>
                            <div>
                                <button pButton pRipple [disabled]="prestationForm?.controls.invalid"  label="Enregistrer" icon="pi pi-check" type="submit" class="p-button-success p-mr-2 p-mb-2" ></button>
                            </div>
                        </div>
                    </form>
                </div>
            </ng-template>
        </p-dialog>


<p-confirmDialog [style]="{width: '450px'}" acceptLabel="Oui" rejectLabel="Non"></p-confirmDialog>
</div>
</div>
