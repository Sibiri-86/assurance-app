<script src="tierPayant-edition.component.ts"></script>
<div class="p-grid">
	<div class="p-col-12">
		<p-toast></p-toast>
		<div class="card">
			<p-toolbar styleClass="p-mb-4">
				<ng-template pTemplate="left">
					<button pButton pRipple label="Ajouter" icon="pi pi-plus" class="p-button-success p-mr-2 p-mb-2" (click)="addTierPayant()"></button>
					<button pButton pRipple label="Supprimer" [disabled]="TierPayantSelected?.length<1" icon="pi pi-trash" (click)="supprimerPrefinancement()" class="p-button-danger p-mb-2"></button>
				</ng-template>
                
			</p-toolbar>


            <p-table #dt [value]="sinistreTierPayantDTOList" [autoLayout]="true" [columns]="cols" [rows]="10" [paginator]="true" [globalFilterFields]="['prestataire.libelle','numeroFacture']"
                     [rowHover]="true" dataKey="id"
                     styleClass="p-datatable-customers"
                     currentPageReportTemplate="affichage {first} à {last} de {totalRecords} enregistrement" [showCurrentPageReport]="true" [(selection)]="TierPayantSelected">
                <ng-template pTemplate="caption">
                    <div class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between table-header">
                        <h5 class="p-m-0"></h5>
                        <span class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Search..." />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th pSortableColumn="duree" style="width:50px" >N° facture<p-sortIcon field="duree"></p-sortIcon></th>
                       
                        <th pSortableColumn="numero" style="width:100px">Prestataire<p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="width:100px">Date de déclaration<p-sortIcon field="nom"></p-sortIcon></th>
                             
                        <th pSortableColumn="duree" style="width:50px">Date de facture<p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="numero" style="width:100px">Montant facture<p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="etat" style="width:50px">Etat<p-sortIcon field="etat"></p-sortIcon></th>
                        <th style="width:175px"></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-tierPayant>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="tierPayant"></p-tableCheckbox>
                        </td>
                        <td> <span class="p-column-title" style="width:50px; font-weight: bold;" >{{tierPayant.numeroFacture}}</span>
                        </td>
                        <td><span class="p-column-title" style="width:100px">{{tierPayant.prestataire.libelle}}</span>
                        </td>
                        <td><span class="p-column-title" style="width:100px">{{tierPayant.dateDeclaration | formatTableValue : 'date'}}</span>
                        </td>

                        
                        
                        <td>
                            <span class="p-column-title" style="width:50px;" >{{tierPayant.dateFacture | formatTableValue : 'date'}}</span>
                        </td>
                        <td>
                            <span class="p-column-title" style="width:50px ;  font-weight: bold;" >{{tierPayant.montantReclame | formatTableValue: 'number':true}}</span>
                        </td>
                        
                        <td>
                            <span *ngIf="tierPayant?.etat ==='VALIDE'" class="p-badge p-badge-success" style="width:90px">{{tierPayant?.etat}}</span>
                            <span *ngIf="tierPayant?.etat ==='ENCOURS'" class="p-badge p-badge-warning" style="width:90px">EN ATTENTE..</span>
                            <span *ngIf="tierPayant?.etat ==='DEVALIDE'" class="p-badge p-badge-danger" style="width:90px">{{tierPayant?.etat}}</span>
                        </td>

                        <td style="width:175px">
                            
                             <button pButton  pRipple icon="pi pi-search" pTooltip="voir prestation" class="p-button-rounded p-button-help p-mr-1" (click)="voirTierPyant(tierPayant)"></button>
                            <button pButton pRipple icon="pi pi-pencil" pTooltip="editer" class="p-button-rounded p-button-warning p-mr-1" (click)="editerTierPayant(tierPayant)"></button>
                            <button pButton icon="pi pi-check" pTooltip="Valider" class="p-button-rounded p-button-success p-mr-1" (click)="validerPrestation(tierPayant)"></button>
                   </td>

                    </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        {{sinistreTierPayantDTOList ? sinistreTierPayantDTOList.length : 0 }} sinistre(s).
                    </div>
                </ng-template>
            </p-table>
        </div>


        <p-dialog [maximizable]="true" [(visible)]="displayPrestation" header="Prestation(s)" [modal]="true" styleClass="p-fluid" [style]="{width: '1500px'}">
            <ng-template pTemplate="content">
                <div class="card">
                    <p-table #dt [value]="prestationListPrefinancementFilter" [columns]="cols" [rows]="10" [paginator]="true"
                     [rowHover]="true" dataKey="id"
                     styleClass="p-datatable-customers"
                     currentPageReportTemplate="affichage {first} à {last} de {totalRecords} enregistrement" [showCurrentPageReport]="true">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="nombreActe" style="width: 120px">nombre acte<p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="width: 200px">Sous acte<p-sortIcon field="nom"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="width: 120px">Cout unitaire<p-sortIcon field="nom"></p-sortIcon></th>
                        <th pSortableColumn="taux" style="width: 120px">Débours<p-sortIcon field="taux.taux"></p-sortIcon></th>
                        <th pSortableColumn="territorialite" style="width: 150px">Base de remboursement<p-sortIcon field="territorialite.libelle"></p-sortIcon></th>
                        <th pSortableColumn="duree" style="width: 120px">montant remboursé <p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="dateSoins" style="width: 120px">Date Soins <p-sortIcon field="duree"></p-sortIcon></th>
                        <th pSortableColumn="territorialite" style="width: 120px">Taux<p-sortIcon field="territorialite.libelle"></p-sortIcon></th>
                        <th pSortableColumn="duree" style="width: 120px">Decision<p-sortIcon field="decision"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-prestation>
                    <tr>

                        <td><span class="p-column-title">{{prestation.nombreActe}}</span>
                        <td><span class="p-column-title">{{prestation.sousActe.libelle}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.coutUnitaire}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.debours}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.baseRemboursement}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.montantRembourse | formatTableValue: 'number':true}}</span></td>
                        <td><span class="p-column-title">{{prestation.dateSoins | formatTableValue: 'date'}}</span></td>
                        <td><span class="p-column-title">{{prestation.taux.taux}}</span>
                        </td>
                        <td><span class="p-column-title">{{prestation.sort}}</span>
                        </td>
                        <td style="min-width:150px">
                            <button pButton pRipple icon="pi pi-trash" pTooltip="supprimer" class="p-button-rounded p-button-warning p-mr-2" (click)="supprimerPrestation(prestation)"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                    <div class="p-d-flex p-ai-center p-jc-between">
                        {{prestationListPrefinancement ? prestationListPrefinancement.length : 0 }} prestation(s).
                    </div>
                </ng-template>
            </p-table>
                </div>
            </ng-template>
        </p-dialog>


        <p-dialog [maximizable]="true" [style]="{width: '1500px'}" [(visible)]="displayFormPrefinancement" header="Tiers Payant" [modal]="true" styleClass="p-fluid" (onHide)="fermerPrestation1()">
            <ng-template pTemplate="content">
                <div class="card">


                    <form>

                        <p-fieldset legend="Sinistre" toggleable="true">

                            <div class="p-fluid p-formgrid p-grid">

                                <div class="p-field p-col-4">
                                    <label for="dateEffet">Date de saisie <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <p-calendar id="dateSaisie" [showIcon]="true" dateFormat="dd/mm/yy" inputId="calendar" disabled [(ngModel)]="prefinancement.dateSaisie" name="dateSaisie"  appendTo="body"></p-calendar>
                                </div>

                                <div class="p-field p-col-4">
                                    <label for="dateDeclaration">Date de déclaration <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <input id="dateDeclaration"  [disabled]="!prefinancement.dateSaisie"  min="001-01-01" max="9999-12-31" type="date" name="dateDeclaration" pInputText [(ngModel)]="prefinancement.dateDeclaration" (change)="compareDateDeclarationAndToday()">

                                </div>

                                <div class="p-field p-col-4">
                                    <label for="dateFacture">Date de Facture<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <input id="dateFacture" min="001-01-01" max="9999-12-31" type="date" [disabled]="!prefinancement.dateDeclaration" name="dateFacture" pInputText [(ngModel)]="prefinancement.dateFacture" (change)="compareDateDeclarationAndDateFacture()">
                                   
                                </div>

                                
                                

                            </div>

                            <div class="p-fluid p-formgrid p-grid">

                                <div class="p-field p-col-4">
                                    <label for="numeroFacture" >Numéro Facture<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <input id="numeroFacture" type="text" [disabled]="!prefinancement.dateFacture"  name="numeroFacture" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prefinancement.numeroFacture" placeholder="numero de facture" pInputText>

                                </div>
                                <div class="p-field p-col-4">
                                    <label for="prestataire" id="prestataire">Prestataire<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <p-dropdown inputId="prestataire" dataKey="id" [filter]="true"
                                                showClear="true" [options]="prestataireList" [disabled]="!prefinancement.numeroFacture"
                                                name="prestataire" [(ngModel)]="prefinancement.prestataire" placeholder="Select centre prescripteur"
                                                optionLabel="libelle" (onChange)="onRowSelectPrestataire($event)"></p-dropdown>
                                </div>

                                <div class="p-field p-col-4">
                                    <label for="montantReclame" >Montant reclamé<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <p-inputNumber  [disabled]="!prefinancement.prestataire"   [(ngModel)]="prefinancement.montantReclame" name="montantReclame" mode="decimal" locale="fr-FR" (change)="initilisation()"   [inputStyle]="{'font-weight': 'bold'}"
                                    placeholder="Saisir le montant reclamé par le prestataire"></p-inputNumber>

                                </div>


                                

                                

                               

                            </div>

                            
                            <div class="p-fluid p-formgrid p-grid">
                                
                                
                            </div>
                            <div class="p-fluid p-formgrid p-grid">
                                
                                <div class="p-field p-col-4">
                                    <label for="montantPaye" >Montant remboursé<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <p-inputNumber [(ngModel)]="prefinancement.montantPaye" name="montantPaye" mode="decimal" locale="fr-FR"  [disabled]="true" [inputStyle]="{'font-weight': 'bold'}"
                                    placeholder="montant(s) saisi(s)"></p-inputNumber>

                                </div>
                                <div class="p-field p-col-4">
                                    <label for="montantRestant" >Montant restant<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                                    <p-inputNumber [(ngModel)]="prefinancement.montantRestant" name="montantRestant" mode="decimal" locale="fr-FR"  [disabled]="true" [inputStyle]="{'font-weight': 'bold'}"
                                    placeholder="montant restant"></p-inputNumber>

                                </div>
                            </div>


                            <div class="p-field p-col-2"></div>
                            <div class="p-fluid p-formgrid p-grid">
                            <div class="p-field p-col-2">
                                <button pButton  [disabled]="!prefinancement.montantReclame"
                                        pRipple icon="pi pi-plus" pTooltip="Ajouter prestation" label="Ajouter prestation"
                                        class="p-button-success" type="button" (click)="addItemPrestation()"></button>
                            </div>

                            <div class="p-field p-col-2">
                                <button pButton  [disabled]="!prefinancement.montantReclame"
                                        pRipple icon="pi pi-plus" pTooltip="Rattacher un bon" label="Rattacher un bon"
                                        class="p-button-success" type="button" (click)="addBon()"></button>
                            </div>
                        </div>
                        </p-fieldset>

                        <hr/>

                        <p-fieldset legend="Liste des Prestations" toggleable="true">
                            <p-table #dt [value]="prestationsList" dataKey="id" editMode="row"  [globalFilterFields]="['sinistreTierPayant.numeroSinistre','adherent.nom','familleActe.libelle',
                            'acte.libelle','sousActe.libelle','adherent.prenom','baseRemboursement','taux.taux','montantRembourse']" responsiveLayout="scroll" [rows]="5" [paginator]="true" [showCurrentPageReport]="true">
                               
                                <ng-template pTemplate="caption">
                                    <div class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between table-header">
                                        <h5 class="p-m-0"></h5>
                                        <span class="p-input-icon-left">
                                        <i class="pi pi-search"></i>
                                        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Search..." />
                                        </span>
                                    </div>
                                </ng-template>
                                <ng-template pTemplate="header">
                                    <tr>
                                    
                                       
                                        <th style="width:8rem">N° Sinistre</th>
                                        <th>Date de soins</th>
                                        <th>Assuré</th>
                                        <th>Famille acte</th>
                                        <th>Acte</th>
                                        <th>Sous Acte</th>
                                        <th>Base de  remboursement</th>
                                        <th>Taux</th>
                                        <th>Montant remboursé</th>
                                        <th style="width:8rem"></th>
                                        
                                    </tr>
                                </ng-template>
                    
                                <ng-template  pTemplate="body" let-rowData let-ri="rowIndex" >
                                    <tr>
                                
                                        <td  style="width:8rem">{{rowData?.sinistreTierPayant?.numeroSinistre}}</td>
                                        <td>{{rowData.dateSoins | formatTableValue : 'date'}}</td>
                                        <td>{{rowData.adherent?.nom}}&nbsp;&nbsp;{{rowData.adherent?.prenom}}</td>
                                        <td>{{rowData.familleActe?.libelle}}</td>
                                        <td>{{rowData.acte?.libelle}}</td>
                    
                                        <td> {{rowData.sousActe?.libelle}}</td>
                                        <td style="font-weight: bold"> {{rowData.baseRemboursement  | formatTableValue: 'number':true}}</td>
                                        <td style="font-weight: bold"> {{rowData.taux?.taux}}</td>
                                        <td style="font-weight: bold"> {{rowData.montantRembourse  | formatTableValue: 'number':true}}</td>
                                        
                                        <td style="text-align:center">
                                            <button  pButton pRipple type="button"  icon="pi pi-pencil" (click)="editerPrestation1(rowData, ri)" class="p-button-rounded p-button-success p-mr-2"></button>
                                            <button pButton pRipple  icon="pi pi-trash" class="p-button-danger p-mb-2" (click)="supprimerPrestation(rowData,ri)"></button>
                    
                    
                                            </td>
                                
                                    </tr>
                                </ng-template>
                            </p-table>
                        </p-fieldset>
                    


                        

                        <br/>

                        <div class="p-grid p-justify-between">
                            <div>
                                <button pButton pRipple label="Quitter" type="button" (click)="closeDialog()" icon="pi pi-times"  class="p-button-danger p-mr-2 p-mb-2" ></button>
                            </div>
                            <div>
                                <button pButton pRipple [disabled]="!prestationsList?.length"   (click)="onCreate()"  label="Enregistrer" icon="pi pi-check" type="button" class="p-button-success p-mr-2 p-mb-2" ></button>
                            </div>
                        </div>
                    </form>
                </div>
            </ng-template>
        </p-dialog>


<p-confirmDialog [style]="{width: '450px'}" acceptLabel="Oui" rejectLabel="Non"></p-confirmDialog>

</div>
</div>

<p-dialog [(visible)]="displayPrestationbon"  header="Veuillez rattaché un bon de prise en charge"  [modal]="true" styleClass="p-fluid">

    <ng-template pTemplate="content">
        <div class="card">
        <form>
            <div class="p-fluid p-formgrid p-grid">
                <div class="p-field p-col-12">
                    <label for="dateSoins">Date de soins <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input id="dateSoins"   type="date" name="dateSoins" pInputText [(ngModel)]="prestationBon.dateSoins">
                </div>
                <div class="p-field p-col-12">
                    <label for="matriculeAdherent">Matricule adhérent <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input id="matriculeAdherent" [disabled]="!prestationBon.dateSoins" type="text"  [(ngModel)]="prestationBon.matriculeAdherent" name="matriculeAdherent"  (blur)="rechercherAdherentBon($event)" pInputText>
                </div>
                <div class="p-field p-col-12">
                    <label for="bonPriseEnCharge">Bon de prise en charge<span style="color: red !important; size: 1.4em;" class="required"></span></label>
                    <p-dropdown inputId="bonPriseEnCharge" dataKey="id" [filter]="true"
                                showClear="true" [options]="bonPriseEnChargeList"  [disabled]="!prestationBon.matriculeAdherent"
                                [(ngModel)]="prestationBon.bonPriseEnCharge"
                                 [autoDisplayFirst]="false"  name="bonPriseEnCharge"
                                optionLabel="numeros">
                            </p-dropdown>
                </div>
            </div>
        </form>
        <div class="p-grid p-justify-between">
            <div>
            </div>
            <div>
                <button pButton  [disabled]="!prefinancement.montantReclame"
                pRipple icon="pi pi-plus" pTooltip="Ajouter bon" label="Ajouter"
                class="p-button-success" type="button" (click)="saveBon()"></button>
            </div>
        </div>
        
        </div>


         
        
     </ng-template>
</p-dialog>
<p-dialog [(visible)]="displayPrestationpop"  header="Veuillez ajouter une prestation"  [modal]="true" styleClass="p-fluid">
    <ng-template pTemplate="header">
        <Span style="font-weight: bold">Montant reclamé: {{prefinancement?.montantReclame | formatTableValue: 'number':true}}</Span>
        <Span *ngIf="prefinancement?.montantReclame > prefinancement?.montantPaye" style="font-weight: bold; color: rgb(12, 125, 12);">Montant remboursé: {{prefinancement?.montantPaye | formatTableValue: 'number':true}}</Span>
        <Span *ngIf="prefinancement?.montantReclame <= prefinancement?.montantPaye" style="font-weight: bold; color: rgb(224, 16, 9);">Montant remboursé: {{prefinancement?.montantPaye | formatTableValue: 'number':true}}</Span>
        <Span style="font-weight: bold" >Montant restant: <span style="color: red !important;" *ngIf="prefinancement?.montantRestant <0">{{prefinancement?.montantRestant | formatTableValue: 'number':true}}</span><span *ngIf="prefinancement?.montantRestant >=0">{{prefinancement?.montantRestant | formatTableValue: 'number':true}}</span></Span>
    </ng-template>
    <ng-template pTemplate="content"> 
        <div class="card">
            <form>

                <div class="p-fluid p-formgrid p-grid">
                    <div class="p-field p-col">
                        <label for="dateSoins">Date de soins <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                        <input id="dateSoins"   type="date" min="001-01-01" max="9999-12-31" name="dateSoins" pInputText [(ngModel)]="prestationAdd.dateSoins" (blur)="rechercheAdherentDateSoin($event)">
                    </div>
                    <div class="p-field p-col">
                        <label for="numeroBon">Numéro Bon <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                        <input id="numeroBon" [disabled]="!prestationAdd.dateSoins"  type="text" name="numeroBon" pInputText [(ngModel)]="prestationAdd.numeroBon">
                    </div>
                    <div class="p-field p-col">
                        <label for="matriculeAdherent">Matricule adhérent <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                        <input id="matriculeAdherent" [disabled]="!prestationAdd.numeroBon" type="text"  [(ngModel)]="prestationAdd.matriculeAdherent" name="matriculeAdherent"  (blur)="rechercherAdherent1($event)" pInputText>
                    </div>
                    <div class="p-field p-col">
                        <label for="nomAdherent">Nom & prenom bénéficiaire<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                        <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="nomAdherent" class="champVert" type="text" disabled  [(ngModel)]="prestationAdd.nomAdherent" name="nomAdherent" pInputText>
                        <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="nomAdherent" class="champRouge" type="text" disabled [(ngModel)]="prestationAdd.nomAdherent" name="nomAdherent"  pInputText>
                    </div>
                
                    
                   
                    
                   
                    
                </div>
            <div class="p-fluid p-formgrid p-grid">
               
                
                <div class="p-field p-col">
                    <label for="groupeAdherent">Numero groupe<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="groupeAdherent" [(ngModel)]="prestationAdd.numeroGroupe" disabled class="champRouge" type="text" name="numeroGroupe" pInputText>
                    <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="groupeAdherent" class="champVert" type="text" disabled [(ngModel)]="prestationAdd.numeroGroupe" name="numeroGroupe" pInputText>
                </div>
                <div class="p-field p-col">
                    <label for="policeAdherent">Numero police<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="policeAdherent" class="champVert" type="text" disabled [(ngModel)]="prestationAdd.numeroPolice" name="numeroPolice" pInputText>
                    <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="policeAdherent" class="champRouge" type="text" disabled [(ngModel)]="prestationAdd.numeroPolice" name="numeroPolice" pInputText>
                </div>

                <div class="p-field p-col">
                    <label for="nomAdherent">Souscripteur<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="souscripteur" class="champVert" disabled type="text" [(ngModel)]="prestationAdd.souscripteur" name="souscripteur"  pInputText>
                    <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="souscripteur" class="champRouge" disabled type="text" [(ngModel)]="prestationAdd.souscripteur" name="souscripteur" pInputText>
                </div>

                <div class="p-field p-col">
                    <label for="nomAdherent">Nom & prenom  Assuré Principal <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                    <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="nomAdherentPrincipal" class="champVert" type="text" disabled [(ngModel)]="prestationAdd.nomAdherentPrincipal" name="nomAdherentPrincipal" pInputText>
                    <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="nomAdherentPrincipal" class="champRouge" type="text" disabled [(ngModel)]="prestationAdd.nomAdherentPrincipal" name="nomAdherentPrincipal"  pInputText>
                </div>
        
           

              
       </div> 

       

           <div class="p-fluid p-formgrid p-grid">
               

            <div class="p-field p-col">
                <label for="nomAdherent">Nom du groupe<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <input *ngIf="adherentSelected?.signeAdherent !=='-'" id="nomGroupe" class="champVert" disabled type="text" [(ngModel)]="prestationAdd.nomGroupe" name="nomGroupe"  pInputText>
                <input *ngIf="adherentSelected?.signeAdherent ==='-'" id="nomGroupe" class="champRouge" disabled type="text" [(ngModel)]="prestationAdd.nomGroupe" name="nomGroupe" pInputText>
            </div>
            <div *ngIf="adherentSelected?.signeAdherent ==='-'" class="p-field p-col">
                <label for="dateEffet">Date de retrait <span style="color: red !important; size: 1.4em;" class="required"></span></label>
                <p-calendar id="dateRetrait" class="champRouge" [showIcon]="true" dateFormat="dd/mm/yy" inputId="calendar" disabled [(ngModel)]="prestationAdd.dateRetrait" name="dateRetrait"  appendTo="body"></p-calendar>
            </div>

              <!-- <div class="p-field p-col">
               <label for="bonPriseEnCharge">Bon de prise en charge<span style="color: red !important; size: 1.4em;" class="required"></span></label>
               <p-dropdown inputId="bonPriseEnCharge" dataKey="id" [filter]="true"
                           showClear="true" [options]="bonPriseEnChargeList"  [disabled]="!prestationAdd.matriculeAdherent"
                           [(ngModel)]="prestationAdd.bonPriseEnCharge"
                            [autoDisplayFirst]="false"  name="bonPriseEnCharge"
                           optionLabel="numeros" (onChange)="onRowSelectBon($event)">
                       </p-dropdown>
           </div>
 -->
          
    
           <div class="p-field p-col">
            <label for="familleActe">Famille acte<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
            <p-dropdown dataKey="id" inputId="garantie" [filter]="true" showClear="true" placeholder="Select famille-acte"
                        [options]="garanties" [disabled]="!prestationAdd.adherent" name="familleActe" [(ngModel)]="prestationAdd.familleActe"  [autoDisplayFirst]="false"
                        optionLabel="libelle" (onChange)="changeGarantie($event)"></p-dropdown>
        </div>
               

               <div class="p-field p-col">
                   <label for="acte">Acte<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                   <p-dropdown dataKey="id" inputId="acte" [disabled]="!prestationAdd.familleActe" [autoDisplayFirst]="false" [filter]="true" showClear="true" placeholder="Select acte"
                               [options]="acteListFilter"  name="acte" [(ngModel)]="prestationAdd.acte" optionLabel="libelle" (onChange)="selectActe($event)"></p-dropdown>
               </div>

               <div class="p-field p-col">
                <label for="sousActe" id="sousActe">SousActe <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-dropdown inputId="sousActe" [filter]="true" [disabled]="!prestationAdd.acte"
                            showClear="true" [options]="sousActeListFilter" name="sousActe"
                            [(ngModel)]="prestationAdd.sousActe" placeholder="Select sous-acte"
                            optionLabel="libelle" (onChange)="selectDateSoins(); findMontantConsomme(); findMontantPlafond();  findTaux()"></p-dropdown>
            </div>

           </div>

           <div class="p-fluid p-formgrid p-grid">

            

            <div class="p-field p-col">
                <label for="pathologie" id="pathologie">Pathologie<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-dropdown inputId="pathologie" dataKey="id" [filter]="true"
                            showClear="true" [options]="pathologieList" name="pathologie" [disabled]="!prestationAdd.sousActe"
                            [(ngModel)]="prestationAdd.pathologie"
                             placeholder="Select pathologie "
                            optionLabel="code"></p-dropdown>
            </div>
            <div class="p-field p-col">
             <label for="prestataire" id="prestataire">Centre Prescripteur<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
             <p-dropdown inputId="prestataire" dataKey="id" [filter]="true" [disabled]="!prestationAdd.pathologie"
                         showClear="true" [options]="prestataireList" name="prestataire" [(ngModel)]="prestationAdd.prestataire"
                          placeholder="Select centre prescripteur"
                         optionLabel="libelle"></p-dropdown>
         </div>
               

             

               <div class="p-field p-col">
                   <label for="produitPharmaceutique" id="produitPharmaceutique">Produit pharmaceutique<span class="required" style="color: red !important; size: 1.4em;" *ngIf="prestationAdd?.familleActe?.code === 'FP'">*</span>
                    <span class="required" *ngIf="prestationAdd?.familleActe?.code !== 'FP'"></span></label>
                  
                   <p-multiSelect inputId="produitPharmaceutique" dataKey="id" [filter]="true"
                                  showClear="true" [options]="produitPharmaceutiqueList" name="produitPharmaceutique" [(ngModel)]="prestationAdd.produitPharmaceutique"
                                   placeholder="Select produit pharmaceutique " [disabled]="!prestationAdd.pathologie" (onChange)="changeDisplay()"
                                  optionLabel="libelle">
                   </p-multiSelect>
               </div>

               <div class="p-field p-col">
                <label for="medecin" id="medecin">Medecin<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-dropdown inputId="medecin" dataKey="id" [filter]="true" [disabled]="displayFP"
                            showClear="true" [options]="medecinList"  name="medecin"  [(ngModel)]="prestationAdd.medecin"
                           placeholder="Select medecin"
                            optionLabel="nom"></p-dropdown>
            </div>

           </div>

           <div class="p-fluid p-formgrid p-grid">

               
            
            <div class="p-field p-col">
                <label for="nombreActe" id="nombreActe">Nombre Acte <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-inputNumber name="nombreActe" [disabled]="!prestationAdd.medecin" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.nombreActe" mode="decimal" locale="fr-FR" placeholder="Nombre Acte"></p-inputNumber>
            </div>
            <div class="p-field p-col">
             <label for="coutUnitaire" id="coutUnitaire">Cout unitaire <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
             <p-inputNumber name="coutUnitaire" [disabled]="!prestationAdd.nombreActe"  [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.coutUnitaire"  mode="decimal" locale="fr-FR" placeholder="cout unitaire" (onBlur)="calculDebours()"></p-inputNumber>
           </div>
           <div class="p-field p-col">
            <label for="coutUnitaire" id="coutUnitaire">Montant exclu <span style="color: red !important; size: 1.4em;" class="required"></span></label>
            <p-inputNumber name="montantExclu" [disabled]="!prestationAdd.coutUnitaire"  [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.montantExclu"  mode="decimal" locale="fr-FR" placeholder="montant exclu" (onBlur)="calculExclu()"></p-inputNumber>
          </div>
              
          <div class="p-field p-col">
            <label for="debours">Debours <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
            <p-inputNumber name="debours" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.debours" [disabled]="true" mode="decimal" locale="fr-FR"></p-inputNumber>
        </div> 

           </div>

           <div class="p-fluid p-formgrid p-grid">

               
           
              
            <div class="p-field p-col">
                <label for="baseRemboursement" id="baseRemboursement">Base remboursement<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-inputNumber name="baseRemboursement" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.baseRemboursement"  [disabled]="true" mode="decimal" locale="fr-FR" placeholder="base de remboursement"></p-inputNumber>
            </div>


            <div class="p-field p-col">
                <label for="taux" id="taux">Taux <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-dropdown inputId="taux" dataKey="id" [filter]="true"
                            showClear="true" [options]="tauxList" name="taux" [(ngModel)]="prestationAdd.taux"
                             placeholder="Select taux"
                            optionLabel="taux" [disabled]="true"></p-dropdown>
            </div>
            <div class="p-field p-col">
             <label for="montantRembourse" id="montantRembourse">Montant remboursé<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
             <p-inputNumber name="montantRembourse" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.montantRembourse"  [disabled]="true" mode="decimal" locale="fr-FR" ></p-inputNumber>
         </div>
         <div class="p-field p-col">
            <label for="nombreActe">Montant supporté<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
            <p-inputNumber  name="montantRestant" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.montantRestant" [disabled]="true" mode="decimal" locale="fr-FR"></p-inputNumber>
        </div> 

            
           </div>

           <div class="p-fluid p-formgrid p-grid">
            
            <div class="p-field p-col-3">
                <label for="sousActe">Decision <span style="color: red !important; size: 1.4em;" class="required">*</span></label>
                <p-dropdown inputId="decision" [filter]="true"
                            showClear="true" [options]="typeSort"
                            name="sort" [(ngModel)]="prestationAdd.sort"
                            [autoDisplayFirst]="false" [disabled]="true"></p-dropdown>
            </div>
            <div class="p-field p-col-3">
             <label for="nombreActe">Montant Plafond<span style="color: red !important; size: 1.4em;" class="required">*</span></label>
             <p-inputNumber  name="montantPlafond" [inputStyle]="{'font-weight': 'bold'}" [(ngModel)]="prestationAdd.montantPlafond" [disabled]="true" mode="decimal" locale="fr-FR"></p-inputNumber>
         </div>

            <div class="p-field p-col">
                <label for="observation">Observation<span style="color: red !important; size: 1.4em;" class="required"></span></label>
                <textarea pInputTextarea name="observation" [(ngModel)]="prestationAdd.observation"  autoResize="autoResize"></textarea>
            </div>
           </div>
        </form>
           

            <div class="p-grid p-justify-between">
                <div>
                <button pButton pRipple label="Quitter" icon="pi pi-times"   (click)="fermerPrestation()"></button>
                </div>
                <div>
                    <button  pButton pRipple label="Enregistrer" [disabled]="!prestationAdd.coutUnitaire"  (click)="addPrestation()" icon="pi pi-check" type="submit"></button>
                </div>
            </div>
            </div>
            </ng-template>
            
 
         
     </p-dialog>

     <p-dialog [maximizable]="true"  [(visible)]="displayFormPrefinancementDetail" header="Tiers Payant" [modal]="true" styleClass="p-fluid" (onHide)="closeDialog()">
        <ng-template pTemplate="content">
            <div class="card">


             

                    <p-fieldset legend="Facture" toggleable="true">

                        <div class="p-fluid p-formgrid p-grid">

                            <div class="p-field p-col-4">
                                <label for="dateEffet">Date de saisie</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.dateSaisie | formatTableValue: 'date'}}
                               
                            </div>

                            <div class="p-field p-col-4">
                                <label for="dateDeclaration">Date de déclaration </label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.dateDeclaration | formatTableValue: 'date'}}

                            </div>

                            <div class="p-field p-col-4">
                                <label for="dateFacture">Date de Facture</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.dateFacture | formatTableValue: 'date'}}
                               
                            </div>

                            
                            

                        </div>

                        <div class="p-fluid p-formgrid p-grid">

                            <div class="p-field p-col-4">
                                <label for="numeroFacture" >Numéro Facture</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.numeroFacture | formatTableValue: 'number':true}}

                            </div>
                            <div class="p-field p-col-4">
                                <label for="prestataire" id="prestataire">Prestataire</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.prestataire?.libelle}}
                                
                            </div>

                            <div class="p-field p-col-4">
                                <label for="montantReclame" >Montant reclamé</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.montantReclame | formatTableValue: 'number':true}}
                                
                            </div>


                            

                            

                         




                        </div>

                      
                        
                        <div class="p-fluid p-formgrid p-grid">
                            
                            <div class="p-field p-col-4">
                                <label for="montantPaye" >Montant Saisie</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.montantPaye | formatTableValue: 'number':true}}
                               

                            </div>
                            <div class="p-field p-col-4">
                                <label for="montantRestant" >Montant restant</label>
                                &nbsp;&nbsp;&nbsp;&nbsp;{{prefinancementDetail.montantRestant | formatTableValue: 'number':true}}
                               

                            </div>
                        </div>

                        <div class="p-field p-col-2"></div>
                        

                    </p-fieldset>

                    <hr/>

                    <p-fieldset legend="Liste des Sinistres" toggleable="true">
                        <p-table #dt [value]="prefinancementDetail.prestation" dataKey="id" [globalFilterFields]="['sinistreTierPayant.numeroSinistre','adherent.nom','familleActe.libelle',
                        'acte.libelle','sousActe.libelle','adherent.prenom','baseRemboursement','taux.taux','montantRembourse']"
                         editMode="row" responsiveLayout="scroll" [rows]="10" [paginator]="true">
                            <ng-template pTemplate="caption">
                                <div class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between table-header">
                                    <h5 class="p-m-0"></h5>
                                    <span class="p-input-icon-left">
                                    <i class="pi pi-search"></i>
                                    <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Search..." />
                                    </span>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="header">
                                <tr>
                                
                                   
                                    <th style="width:8rem">N° Sinistre</th>
                                    <th>Date de soins</th>
                                    <th>Assuré</th>
                                    <th>Famille acte</th>
                                    <th>Acte</th>
                                    <th>Sous Acte</th>
                                    <th>Base de  remboursement</th>
                                    <th>Taux</th>
                                    <th>Montant remboursé</th>
                                    <th style="width:8rem"></th>
                                    
                                </tr>
                            </ng-template>
                
                            <ng-template  pTemplate="body" let-rowData let-ri="rowIndex" >
                                <tr>
                            
                                    <td  style="width:8rem">{{rowData?.sinistreTierPayant?.numeroSinistre}}</td>
                                    <td>{{rowData.dateSoins | formatTableValue : 'date'}}</td>
                                    <td>{{rowData.adherent?.nom}}&nbsp;&nbsp;{{rowData.adherent?.prenom}}</td>
                                    <td>{{rowData.familleActe?.libelle}}</td>
                                    <td>{{rowData.acte?.libelle}}</td>
                
                                    <td> {{rowData.sousActe?.libelle}}</td>
                                   
                                    
                                    <td style="font-weight: bold"> {{rowData.baseRemboursement  | formatTableValue: 'number':true}}</td>
                                    <td style="font-weight: bold"> {{rowData.taux?.taux}}</td>
                                    
                                    <td style="font-weight: bold"> {{rowData.montantRembourse  | formatTableValue: 'number':true}}</td>
                                    

                                    <td style="text-align:center">
                                        <button  pButton pRipple type="button"  icon="pi pi-eye" (click)="voirPrestationDetail(rowData, ri)" class="p-button-rounded p-button-success p-mr-2"></button>
                                        <button pButton pRipple icon="pi pi-print" pTooltip="Imprimer" class="p-button-rounded p-button-info" (click)="imprimerPrestation(rowData)"></button>

                
                                        </td>
                            
                                </tr>
                            </ng-template>
                        </p-table>
                    </p-fieldset>
           
                    
                


                    

                    <br/>

                    
            </div>
        </ng-template>
    </p-dialog>


    <p-dialog [maximizable]="true"  [(visible)]="displaySinistreDetail" header="Prestation" [modal]="true" styleClass="p-fluid" (onHide)="closeDialog()">
        <ng-template pTemplate="content">
            <div class="card">

                <div class="p-fluid p-formgrid p-grid">
                    <div class="p-field p-col-3">
                        <label for="dateSoins">Date de soins</label>
                        &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.dateSoins | formatTableValue: 'date'}}
                    </div>
                   
    
                  <div class="p-field p-col-3">
                   <label for="exercice">Nom </label> 
                   &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.adherent?.nom}}
                </div>
                   <div class="p-field p-col-3">
                    <label for="exercice">Prénom </label> 
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.adherent?.prenom}}
                   
              </div>

              <div class="p-field p-col-3">
                <label for="exercice">Numéro groupe</label> 
                &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.adherent?.numeroGroupe}}
               
          </div>
         
               
    
                  
           </div> 
    
           
    
               <div class="p-fluid p-formgrid p-grid">
                   
    
                <div class="p-field p-col-3">
                    <label for="exercice">Numéro police</label> 
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.adherent?.groupe?.police?.numero}}
                   
              </div>
            
                      <div class="p-field p-col-3">
                       <label for="bonPriseEnCharge">Bon de prise en charge</label>
                       &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.bonPriseEnCharge?.numeros}}
                       
                   </div>
            
                   <div class="p-field p-col-3">
                    <label for="familleActe">Famille acte</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.familleActe?.libelle}}
                    
                </div>
                  
    
                   <div class="p-field p-col-3">
                       <label for="acte">Acte</label>
                       &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.acte?.libelle}}
                      
                   </div>
    
                   
    
               </div>
    
               <div class="p-fluid p-formgrid p-grid">
    
                <div class="p-field p-col-3">
                    <label for="sousActe" id="sousActe">SousActe</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.sousActe?.libelle}}
              
                </div>
 
                <div class="p-field p-col-3">
                    <label for="pathologie" id="pathologie">Pathologie</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.pathologie?.code}}
                    
                </div>
                <div class="p-field p-col-3">
                 <label for="prestataire" id="prestataire">Centre Prescripteur</label>
                 &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.prestataire?.libelle}}
                 
             </div>
                   <div class="p-field p-col-3">
                       <label for="produitPharmaceutique" id="produitPharmaceutique">Produit pharmaceutique</label>
                       <span **ngFor="let item of prestationDetail?.produitPharmaceutique"></span>
                       &nbsp;&nbsp;&nbsp;&nbsp;{{item?.libelle}}
                      
                   </div>
    
                   
    
               </div>
    
               <div class="p-fluid p-formgrid p-grid">
    
                <div class="p-field p-col-3">
                    <label for="medecin" id="medecin">Medecin</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.medecin?.nom}}
                    
                </div>
                <div class="p-field p-col-3">
                    <label for="nombreActe" id="nombreActe">Nombre Acte</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.nombreActe | formatTableValue: 'number':true}}
                </div>
                <div class="p-field p-col-3">
                 <label for="coutUnitaire" id="coutUnitaire">Cout unitaire </label>
                 &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.coutUnitaire | formatTableValue: 'number':true}}
               </div>
                  
                   <div class="p-field p-col-3">
                       <label for="debours">Debours</label>
                       &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.debours | formatTableValue: 'number':true}}
                   </div>
                   
               </div>
    
               <div class="p-fluid p-formgrid p-grid">
                
                <div class="p-field p-col-3">
                    <label for="baseRemboursement" id="baseRemboursement">Base remboursement</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.baseRemboursement | formatTableValue: 'number':true}}
                </div>
 
 
                <div class="p-field p-col-3">
                    <label for="taux" id="taux">Taux </label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.taux?.taux}}
                    
                </div>
                <div class="p-field p-col-3">
                 <label for="montantRembourse" id="montantRembourse">Montant remboursé</label>
                 &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.montantRembourse | formatTableValue: 'number':true}}
             </div>
 

                   <div class="p-field p-col-3">
                    <label for="nombreActe">Montant Plafond</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.montantPlafond | formatTableValue: 'number':true}}
                </div>

               
    
                   
    
               </div>
               <div class="p-fluid p-formgrid p-grid">
                <div class="p-field p-col-3">
                    <label for="nombreActe">Numero du Bon</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;{{prestationDetail.numeroBon | formatTableValue: 'number':true}}
                </div>
               </div>
               

            </div>
        </ng-template>
    </p-dialog>
    <p-dialog [(visible)]="showMessage" header="Plafond presque atteint" [modal]="true" styleClass="p-fluid" [style]="{width: '1000px'}">
        <ng-template pTemplate="content">
            <div class="card primeeee">
            <span class="prime">{{montantReponse.message}} </span><br></div>
        </ng-template>
    </p-dialog>

    <p-dialog [(visible)]="showAlert" header="Attention au montant remboursé" [modal]="true" styleClass="p-fluid" [style]="{width: '1000px'}">
        <ng-template pTemplate="content">
            <div class="card primeeee">
            <span class="prime">Attention, le montant remboursé est supérieur à celui réclamé de {{prefinancement?.montantReclame - prefinancement?.montantPaye | formatTableValue: 'number':true}} FCFA </span><br></div>
        </ng-template>
    </p-dialog>
